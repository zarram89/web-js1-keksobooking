# Личный проект «Кексобукинг»

* Студент: [Рамиль Зарипов](https://github.com/zarram89).
* Наставник: `Неизвестно`.

## Техническое задание

### О проекте
Кексобукинг — сервис размещения объявлений о сдаче в аренду недвижимости в центре Токио. Пользователям предоставляется возможность размещать объявления о своей недвижимости или просматривать уже размещённые объявления.

### Описание функциональности

#### 1. Состояния страницы
1.1. **Неактивное состояние.** При открытии страница находится в неактивном состоянии:
* На месте карты отображается серый прямоугольник.
* Форма заполнения информации об объявлении `.ad-form` содержит класс `ad-form--disabled`;
* Все интерактивные элементы формы `.ad-form` должны быть заблокированы с помощью атрибута `disabled`, добавленного на них или на их родительские блоки `fieldset`. Слайдер также должен быть заблокирован;
* Форма с фильтрами `.map__filters` заблокирована так же, как и форма `.ad-form` — на форму добавлен специальный класс, а на её интерактивные элементы атрибуты `disabled`.

1.2. **Активное состояние.** Загрузка и успешная инициализация карты (карта реализуется сторонней библиотекой Leaflet) переводит страницу в активное состояние. В активном состоянии страница позволяет:
* Вносить изменения в форму и отправлять её на сервер;
* После загрузки данных с сервера просматривать похожие объявления на карте, фильтровать их и уточнять подробную информацию о них, показывая для каждого из объявлений карточку.

#### 2. Заполнение информации
2.1. Заполнение информации и отправка данных:
* фотография пользователя;
* заголовок объявления;
* адрес (координаты);
* тип жилья;
* цена за ночь;
* количество комнат;
* количество спальных мест;
* время заезда и выезда из квартиры;
* дополнительные параметры:
  * парковка;
  * Wi-Fi;
  * кондиционер;
  * столовая;
  * стиральная машина;
  * лифт.
* описание объявления;
* фотография жилья.

2.2. Заполнение всей информации производится на одной странице без промежуточных переходов. Порядок заполнения информации не важен.

2.3. После заполнения всех данных, при нажатии на кнопку «Опубликовать», все данные из формы, включая изображения, с помощью AJAX-запроса отправляются на сервер `https://25.javascript.htmlacademy.pro/keksobooking` методом POST с типом `multipart/form-data`. На время выполнения запроса к серверу кнопка «Опубликовать» блокируется.

2.4. Страница реагирует на неправильно введённые значения в форму. Если данные, введённые в форму, не соответствуют ограничениям, указанным в п. 3 этого техзадания, описывающем поля ввода, форму невозможно отправить на сервер. При попытке отправить форму с неправильными данными, отправки не происходит, а пользователю показываются ошибки для неверно заполненных полей (для проверки данных используется сторонняя библиотека Pristine).

2.5. При успешной отправке формы или её очистке (нажатие на кнопку `.ad-form__reset`) страница, не перезагружаясь, переходит в состояние, когда:
* все заполненные поля возвращаются в изначальное состояние;
* фильтрация (состояние фильтров и отфильтрованные метки) сбрасывается;
* метка адреса возвращается в исходное положение;
* значение поля адреса корректируется соответственно исходному положению метки;
* если на карте был показан балун, то он должен быть скрыт.

2.6. Если отправка данных прошла успешно, показывается соответствующее сообщение. Разметку сообщения, которая находится блоке `#success` внутри шаблона `template`, нужно разместить перед закрывающим тегом `</body>`. Сообщение должно исчезать по нажатию на клавишу Esc и по клику на произвольную область экрана.

2.7. Если при отправке данных произошла ошибка запроса, показывается соответствующее сообщение. Разметку сообщения, которая находится в блоке `#error` в шаблоне `template`, нужно разместить перед закрывающим тегом `</body>`. Сообщение должно исчезать после нажатия на кнопку `.error__button`, по нажатию на клавишу Esc и по клику на произвольную область экрана. В таком случае вся введённая пользователем информация сохраняется, чтобы у него была возможность отправить форму повторно.

#### 3. Ограничения, накладываемые на поля ввода
3.1. Заголовок объявления:
* Обязательное текстовое поле;
* Минимальная длина — 30 символов;
* Максимальная длина — 100 символов.

3.2. Цена за ночь:
* Обязательное поле;
* Числовое поле;
* Максимальное значение — 100 000.
* Пользователь может вписать цену в поле, а может указать её перемещением ползунка слайдера. Слайдер реализуется сторонней библиотекой noUiSlider.

3.3. Поле «Тип жилья» влияет на минимальное значение поля «Цена за ночь»:
* «Бунгало» — минимальная цена за ночь 0;
* «Квартира» — минимальная цена за ночь 1 000;
* «Отель» — минимальная цена за ночь 3 000;
* «Дом» — минимальная цена 5 000;
* «Дворец» — минимальная цена 10 000.
  Обратите внимание, вместе с минимальным значением цены нужно изменять и плейсхолдер.

3.4. Адрес: ручное редактирование поля запрещено. Значение автоматически выставляется при перемещении специальной метки по карте. Подробности заполнения поля адреса описаны вместе с поведением метки.

3.5. Поля «Время заезда» и «Время выезда» синхронизированы: при изменении значения одного поля во втором выделяется соответствующее ему значение. Например, если время заезда указано «после 14», то время выезда будет равно «до 14» и наоборот.

3.6. Поле «Количество комнат» синхронизировано с полем «Количество мест» таким образом, что при выборе количества комнат вводятся ограничения на допустимые варианты выбора количества гостей:
* 1 комната — «для 1 гостя»;
* 2 комнаты — «для 2 гостей» или «для 1 гостя»;
* 3 комнаты — «для 3 гостей», «для 2 гостей» или «для 1 гостя»;
* 100 комнат — «не для гостей».

3.7. Значением полей «Ваша фотография» и «Фотография жилья» может быть только изображение. При выборе изображений пользователем в форме должны отобразиться превью аватарки пользователя и фотографии помещения соответственно.

#### 4. Выбор адреса на карте
4.1. Приблизительный адрес квартиры указывается перемещением специальной метки по карте Токио. Содержимое поля адреса должно всегда соответствовать координатам метки.

4.2. Поле адреса должно быть заполнено всегда, в том числе сразу после активации страницы. По умолчанию используются координаты центра Токио.

4.3. Формат значения поля адреса: `lat, lng`, где lat и lng — это координаты метки (от англ. latitude и longitude, широта и долгота). Данные предоставляются API карт. Дробные координаты округляются до пяти символов после запятой.

#### 5. Сравнение с похожими объявлениями
5.1. Полный список похожих объявлений загружается после перехода страницы в активное состояние с сервера `https://25.javascript.htmlacademy.pro/keksobooking/data`. В объявлениях, полученных с сервера, может отсутствовать часть информации. Это нормально! Ведь при добавлении объявления пользователь может оставить необязательные поля пустыми.

5.2. Если при загрузке данных с сервера произошла ошибка запроса, нужно показать соответствующее сообщение. Дизайн блока с сообщением нужно придумать самостоятельно.

5.3. Каждое из объявлений показывается на карте в виде метки. Размеры метки похожего объявления — 40 на 40, размеры специальной метки выбора адреса — 52 на 52.

5.4. При нажатии на метку похожего объявления, показывается балун (предоставляется API карт) с подробной информацией об объявлении (далее — карточка). Разметка карточки должна создаваться на основе шаблонного элемента `.popup`, расположенного в элементе template с идентификатором `#card`. Данные в карточку вставляются по аналогии с данными, вставленными в шаблонную карточку в качестве примера. Если данных для заполнения не хватает, потому что в объявлении отсутствует часть информации, соответствующий блок в карточке скрывается. Например, если в объявлении не указано никаких удобств, нужно скрыть блок `.popup__features`.

5.5. Нажатие на специальную метку выбора адреса не приводит к показу балуна.

5.6. В каждый момент времени может быть показан только один балун, то есть нажатие на метку другого похожего объявления должно скрывать текущий балун, если он показан, и показывать балун, соответствующий другому объявлению.

5.7. Открытую карточку с подробной информацией можно закрыть нажатием на крестик в углу балуна.

5.8. Объекты, расположенные неподалёку, можно фильтровать. Фильтрация производится при изменении значений соответствующих полей формы `.map__filters` по тем же параметрам, которые указываются для объявления:
* тип жилья;
* цена за ночь;
* число комнат;
* число гостей;
* дополнительные удобства.

5.9. Как до изменения фильтров, так и при изменении фильтра, на карте должны показываться все подходящие варианты, но не более 10 меток (не считая специальной), независимо от выбранного фильтра. Показанные метки должны удовлетворять всем выбранным фильтрам.

5.10. Форма, с помощью которой производится фильтрация похожих объявлений на момент открытия страницы, заблокирована и становится доступной только после окончания загрузки всех похожих объявлений, которые, в свою очередь, начинают загружаться только после загрузки и успешной инициализации карты. Если при загрузке данных с сервера произошла ошибка запроса, то форма остаётся недоступной.

5.11. Отрисовка соответствующих выбранным фильтрам меток должна происходить не чаще, чем раз в полсекунды (устранение дребезга).

5.12. При изменении фильтров открытый балун (при наличии) должен быть скрыт.

## Задача 1: Генерация данных

В этом задании наша цель научиться генерировать временные данные для дальнейшей разработки интерфейса. Данные хоть временные и ненастоящие, но должны быть идентичны по своей структуре оригинальным.

### Генерация данных
В файле `main.js` на основе написанных в прошлом задании вспомогательных функций напишите необходимые функции для создания массива из 10 сгенерированных JS-объектов. Каждый объект массива — описание похожего объявления неподалёку.

Структура каждого объекта должна быть следующей:

**author**, объект — описывает автора. Содержит одно поле:
* `avatar`, строка — адрес изображения вида `img/avatars/user{{xx}}.png`, где {{xx}} — это число от 1 до 10. Перед однозначными числами ставится 0. Например, 01, 02...10. Адреса изображений не повторяются.

**offer**, объект — содержит информацию об объявлении. Состоит из полей:
* `title`, строка — заголовок предложения. Придумайте самостоятельно.
* `address`, строка — адрес предложения. Для простоты пусть пока составляется из географических координат по маске `{{location.lat}}, {{location.lng}}`.
* `price`, число — стоимость. Случайное целое положительное число.
* `type`, строка — одно из пяти фиксированных значений: `palace`, `flat`, `house`, `bungalow` или `hotel`.
* `rooms`, число — количество комнат. Случайное целое положительное число.
* `guests`, число — количество гостей, которое можно разместить. Случайное целое положительное число.
* `checkin`, строка — одно из трёх фиксированных значений: `12:00`, `13:00` или `14:00`.
* `checkout`, строка — одно из трёх фиксированных значений: `12:00`, `13:00` или `14:00`.
* `features`, массив строк — массив случайной длины из значений: `wifi`, `dishwasher`, `parking`, `washer`, `elevator`, `conditioner`. Значения не должны повторяться.
* `description`, строка — описание помещения. Придумайте самостоятельно.
* `photos`, массив строк — массив случайной длины из значений: `https://assets.htmlacademy.ru/content/intensive/javascript-1/keksobooking/duonguyen-8LrGtIxxa4w.jpg`, `https://assets.htmlacademy.ru/content/intensive/javascript-1/keksobooking/brandon-hoogenboom-SNxQGWxZQi0.jpg`, `https://assets.htmlacademy.ru/content/intensive/javascript-1/keksobooking/claire-rendall-b6kAwr1i0Iw.jpg`.

**location**, объект — местоположение в виде географических координат. Состоит из двух полей:
* `lat`, число с плавающей точкой — широта, случайное значение от 35.65000 до 35.70000.
* `lng`, число с плавающей точкой — долгота, случайное значение от 139.70000 до 139.80000.

## Задача 2: Разделите код на модули

Разделите код, уже написанный в `main.js`, на отдельные ES2015-модули. `main.js` станет главным модулем, точкой входа. В этом файле должны остаться только импорты других модулей, а также код, который необходим для их работы.

### Пример разбиения на модули
* `main.js` — точка входа. Модуль, который связывает другие модули;
* `util.js` — модуль с вспомогательными функциями;
* `data.js` — модуль, который создаёт данные.

Указанное выше разделение на модули — это только пример. Вы можете разделить код на модули так, как считаете нужным.

Импортируйте нужные модули в точку входа, а точку входа подключите в `index.html` как скрипт-модуль.

По желанию, вы можете перечитать техническое задание и подумать, какие ещё модули потребуются в приложении, а после завести под них пустые файлы, чтобы сразу обозначить файловую структуру проекта.

## Задача 3: Генерация разметки похожих объявлений

Подготовить код для генерации разметки похожих объявлений на основе данных.

### Описание задания
Заведите модуль, который будет отвечать за генерацию разметки похожих элементов.
На основе временных данных для разработки и шаблона `#card` создайте DOM-элементы, соответствующие объявлениям, и заполните их данными.
Предусмотрите ситуацию, когда данных для заполнения не хватает. Например, отсутствует описание. В этом случае соответствующий блок в карточке скрывается.
Отрисуйте один из сгенерированных DOM-элементов, например первый, в блок `#map-canvas`.

### Реализация
* Создан модуль `js/card.js`, который содержит функцию `renderCard(ad)`.
* Функция `renderCard` клонирует шаблон `#card`, заполняет его данными из объекта объявления и обрабатывает отсутствующие данные.
* В модуле `js/main.js` импортирована функция `renderCard` и используется для отрисовки первого объявления в блок `#map-canvas`.

## Задача 4: Переключение режимов страницы

Кекстаграм
Кексобукинг
В этом задании мы начнём реализацию сценария переключения режимов страницы между неактивным и активным. Так как переключение режимов завязано на карте, сейчас мы выполним все подготовительные работы, а после, в другом задании, свяжем переключение с картой.

### Описание задания
Заведите модуль, который будет отвечать за работу с формой.
Реализуйте с помощью JavaScript (удобнее функцией!) перевод страницы в неактивное состояние. Все пункты, кроме первого про карту.
Важно. Неактивность должна добавляться именно средствами JavaScript, иначе, если классы и атрибуты добавить напрямую в HTML, при ошибке в скриптах или ошибке загрузки скриптов сайт будет недоступен пользователю.
Напишите функцию, которая будет переводить страницу в активное состояние. В задании про карту мы будем вызывать эту функцию, когда карта будет загружена и готова к работе, а пока вы можете просто вызвать эту функцию активации в своём коде.

### Реализация
* В модуле `js/form.js` реализованы функции `disablePage` и `enablePage`.
* Функция `disablePage` добавляет класс `ad-form--disabled` форме объявления и `map__filters--disabled` форме фильтрации, а также устанавливает атрибут `disabled` для всех интерактивных элементов внутри этих форм.
* Функция `enablePage` удаляет вышеуказанные классы и атрибуты `disabled`.
* В `js/main.js` вызываются функции `disablePage()` (для инициализации) и `enablePage()` (для симуляции активации).

## Задача 5: Валидация формы

Добавить в проект валидацию, проверки введённых данных, чтобы подсказать пользователю, какие данные мы от него ждём, а себе и бэкендеру упростить работу с этими данными.

### Описание задания
Заведите модуль, который будет отвечать за работу с формой, если вы ещё этого не сделали.
Пропишите тегу `<form>` правильные значения атрибутов `method` и адрес `action` для отправки формы на сервер.
Проверьте разметку вашего проекта и добавьте недостающие атрибуты. Например, всем обязательным полям нужно добавить атрибут `required`. Затем проверьте, правильные ли типы стоят у нужных полей, если нет — проставьте правильные.
Напишите код для валидации формы добавления объявления. Список полей для валидации:
* Заголовок объявления
* Цена за ночь
* Количество комнат и количество мест

### Реализация
* В `index.html` подключена библиотека `Pristine` (`pristine/pristine.min.js`).
* Тегу `<form>` добавлены атрибуты `action`, `method`, `enctype`.
* Полям ввода (`#title`, `#price`) добавлены атрибуты `required`, `minlength`, `maxlength`, `max` для нативной валидации и валидации через Pristine.
* В модуле `js/form.js` инициализирована библиотека `Pristine`.
* Реализована сложная валидация зависимости количества комнат от количества гостей с помощью `pristine.addValidator`.
* Добавлены обработчики событий для синхронизации проверки полей количества комнат и мест.
* Реализована отмена отправки формы, если валидация не проходит.

## Задача 6: Обработка действий пользователя

Продолжим улучшать форму добавления нового объявления. Нам осталось обработать действия пользователя в полях «Тип жилья» и «Время заезда-выезда».

### Описание задания
В модуле формы напишите код, который реализует логику обработки пользовательского ввода для полей:
* «Тип жилья» — выбор опции меняет атрибуты минимального значения и плейсхолдера поля «Цена за ночь». На основе атрибута с минимальным значением должна отрабатывать валидация поля «Цена за ночь».
* «Время заезда», «Время выезда» — выбор опции одного поля автоматически изменят значение другого.

### Реализация
* В модуле `js/form.js` добавлен словарь `minPrices` для сопоставления типов жилья и минимальных цен.
* Реализован обработчик изменения типа жилья, который обновляет `placeholder` и `min` атрибут поля цены, а также запускает валидацию цены.
* Добавлен валидатор для цены, проверяющий соответствие минимальному значению выбранного типа жилья.
* Реализованы обработчики изменения времени заезда и выезда, которые синхронизируют значения этих полей.

## Задача 7: Интерактивная карта

В этом задании мы добавим в проект интерактивную карту и продолжим реализацию сценария переключения режимов страницы между неактивным и активным, который завязан на карте.

### Описание задания
* Удалите код отрисовки одного из сгенерированных DOM-элементов объявления, который был нужен только для разработки.
* С помощью полученных обновлений (стили, изображения и скрипты, необходимые для Leaflet) реализуйте отображение карты и дальнейший переход страницы в активное состояние после инициализации карты.
* Напишите код, который будет добавлять на карту специальную, «главную», метку.
* Реализуйте с помощью API карт выбор адреса путём перемещения главной метки.
* Напишите код, который добавит на карту метки объявлений, «обычные».
* С помощью API карт реализуйте показ балуна с подробной информацией об объявлении.
* С помощью полученных обновлений (стили и скрипты, необходимые для noUiSlider) реализуйте указание цены за ночь.

### Реализация
* В `index.html` подключены библиотеки `Leaflet` и `noUiSlider`.
* Создан модуль `js/map.js` для инициализации карты и управления метками.
* Карта инициализируется с центром в Токио. После загрузки карты страница переводится в активное состояние.
* Добавлена главная метка (draggable), при перемещении которой обновляется поле адреса.
* Добавлены метки объявлений, при клике на которые открывается балун с карточкой объявления (используется `renderCard`).
* В `js/form.js` добавлена функция `initSlider` для инициализации слайдера цен с помощью `noUiSlider`.
* Слайдер синхронизирован с полем цены: изменение слайдера меняет цену, изменение цены меняет положение слайдера.

## Задача 8: Работа с сервером

Отказаться от использования временных данных для разработки и создать модуль для работы с сервером.

### Описание задания
* Создайте модуль `js/api.js` и опишите в нём функции взаимодействия c удалённым сервером с помощью fetch для получения и отправки данных.
* Доработайте модуль для отрисовки меток на карте так, чтобы в качестве данных использовались не случайно сгенерированные объекты, а те данные, которые вы загрузите с сервера.
* Добавьте обработку возможных ошибок при загрузке.
* Добавьте обработчик отправки формы, который бы отменял действие формы по умолчанию и отправлял данные формы посредством fetch на сервер.
* Реализуйте возвращение формы в исходное состояние при успешной отправке, а также показ сообщения пользователю.
* Если при отправке данных произошла ошибка запроса, покажите соответствующее сообщение.
* Похожим образом обработайте нажатие на кнопку сброса.

### Реализация
* Создан модуль `js/api.js` с функциями `getData` и `sendData` для взаимодействия с сервером.
* Создан модуль `js/message.js` для отображения сообщений об успехе, ошибке и предупреждений.
* В `js/map.js` функция `initMap` теперь принимает колбэк `onLoad`, который вызывается после загрузки карты.
* В `js/main.js` реализована логика: сначала инициализируется карта, затем загружаются данные с сервера. Если данные загружены успешно, отрисовываются метки. Если нет — показывается сообщение об ошибке.
* В `js/form.js` реализована отправка формы через `sendData`.
  * При успешной отправке показывается сообщение об успехе, форма и карта сбрасываются в исходное состояние.
  * При ошибке показывается сообщение об ошибке.
* Реализован сброс формы и карты по нажатию на кнопку «Очистить».

## Задача 9: Фильтрация

Вывести на карту не более 10 меток. Ограничение по количеству должно происходить сразу после получения данных с сервера.
Реализовать фильтрацию объявлений по типу жилья, цене, количеству комнат, количеству гостей и удобствам.
Все выбранные фильтры применяются вместе.
Использовать «устранение дребезга» (debounce) для задержки обновления меток при переключении фильтров.

### Реализация
* Создан модуль `js/filter.js`:
  * Реализована функция `filterAds`, которая фильтрует массив объявлений по всем критериям и возвращает не более 10 результатов.
  * Реализована функция `setFilterListener`, которая добавляет обработчик изменений на форму фильтров.
* В `js/util.js` добавлена функция `debounce` для задержки выполнения функции.
* В `js/map.js` обновлена функция `renderMarkers`: теперь она очищает слой с метками перед добавлением новых (используется `L.layerGroup`).
* В `js/main.js` интегрирована фильтрация:
  * При успешной загрузке данных сразу отрисовываются отфильтрованные объявления (максимум 10).
  * Установлен обработчик изменений фильтров с использованием `debounce`, который перерисовывает метки в соответствии с новыми фильтрами.
